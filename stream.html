<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eyeling × Wikidata — Streaming Closure + Dynamic Fetch (CORS-safe)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#1b2430;
      --muted:#5b6b7c;
      --line:#d6dee8;
      --btn:#2563eb;
      --btn2:#e7edf7;
      --codebg:#f3f5f9;
    }
    html, body{ margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .topbar{
      padding:10px 12px; border-bottom:1px solid var(--line);
      display:flex; gap:10px; align-items:center; background:#fff;
      position:sticky; top:0; z-index:10;
    }
    .topbar input{
      background:#fff; border:1px solid var(--line); color:var(--text);
      padding:9px 10px; border-radius:10px; flex:1;
    }
    .topbar button{
      background:var(--btn); border:0; color:#fff; padding:9px 12px;
      border-radius:10px; cursor:pointer; font-weight:700; white-space:nowrap;
    }
    .topbar button.secondary{
      background:var(--btn2); color:var(--text); border:1px solid var(--line);
      font-weight:700;
    }
    .topbar button:disabled{ opacity:.55; cursor:not-allowed; }

    .layout{
      display:grid; grid-template-columns:1fr 1fr; gap:12px; padding:12px;
      box-sizing:border-box; max-width:1500px; margin:0 auto; align-items:start;
    }
    @media (max-width: 980px){ .layout{ grid-template-columns:1fr; } }
    .col{ display:flex; flex-direction:column; gap:12px; min-width:0; }

    .panel{
      background:var(--panel); border:1px solid var(--line); border-radius:14px;
      display:flex; flex-direction:column; overflow:hidden;
      box-shadow:0 4px 16px rgba(16,24,40,.06);
    }
    .panel h2{
      margin:0; padding:10px 12px; font-size:14px; font-weight:900;
      border-bottom:1px solid var(--line); color:var(--muted);
      letter-spacing:.2px;
    }
    .panel .content{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row label{ font-size:12px; color:var(--muted); display:flex; gap:6px; align-items:center; }
    .muted{ color:var(--muted); font-size:12px; }
    .status{ font-size:12px; color:var(--muted); }
    .badge{
      display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px;
      border:1px solid var(--line); background:#fff; color:var(--muted);
    }

    textarea{
      width:100%; background:var(--codebg); border:1px solid var(--line);
      color:var(--text); padding:10px; border-radius:12px; box-sizing:border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; line-height:1.35;
    }
    textarea.preview{ height:220px; overflow:auto; resize:vertical; }
    textarea.rules{ height:min(42vh, 420px); min-height:240px; overflow:auto; resize:vertical; }

    .list{ display:flex; flex-direction:column; gap:8px; max-height:240px; overflow:auto; padding-right:2px; }
    .item{ padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff; cursor:pointer; user-select:none; }
    .item:hover{ border-color:#9db6ee; box-shadow:0 2px 10px rgba(37,99,235,.10); }
    .item.selected{ border-color:#2563eb; box-shadow:0 2px 12px rgba(37,99,235,.16); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .out{
      white-space:pre-wrap; word-break:break-word; background:var(--codebg);
      border:1px solid var(--line); border-radius:12px; padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; line-height:1.35;
      max-height:min(52vh, 560px); overflow:auto;
    }

    .modalBackdrop{
      position:fixed; inset:0; background:rgba(12,18,28,.55); display:none;
      align-items:center; justify-content:center; padding:18px; z-index:1000;
    }
    .modal{
      width:min(1100px, 96vw); height:min(86vh, 900px); background:#fff;
      border-radius:16px; border:1px solid var(--line);
      box-shadow:0 20px 80px rgba(0,0,0,.25);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .modalHeader{
      padding:10px 12px; border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px; background:#fff;
    }
    .modalHeader .title{ font-weight:900; color:var(--muted); font-size:14px; }
    .modalBody{ padding:12px; display:flex; flex-direction:column; gap:10px; height:100%; }
    textarea.full{ flex:1 1 auto; height:100%; resize:none; overflow:auto; }
  </style>
</head>
<body>
  <div class="topbar">
    <input id="searchBox" placeholder="Search Wikidata (e.g., René Magritte, Q7836)..." />
    <button id="searchBtn">Search</button>
    <button id="loadBtn" class="secondary" disabled>Load selection</button>
    <button id="toyBtn" class="secondary">Load toy example</button>
    <button id="clearBtn" class="secondary">Clear output</button>
    <label class="muted" style="display:flex;align-items:center;gap:6px;margin-left:4px;"><input type="checkbox" id="clearOnRun" />clear on run</label>
    <span id="eyelingVersion" class="badge" style="margin-left:auto">Eyeling</span>
    <button id="reasonBtn" disabled>Reason (stream)</button>
  </div>

  <div class="layout">
    <!-- LEFT: browser + dataset -->
    <div class="col">
      <section class="panel">
        <h2>Wikidata browser + dataset</h2>
        <div class="content">
          <div class="row">
            <label title="Uses Wikidata API (origin=*) instead of EntityData .ttl, so it works under CORS">
              <input type="checkbox" id="minimalOnly" checked />
              minimal dataset (entity-value claims + sitelinks)
            </label>
            <label title="If derived triples request wikiquote, fetch extract via it.wikiquote API (origin=*)">
              <input type="checkbox" id="autoFetchWikiquote" checked />
              auto-fetch it.wikiquote extract when requested
            </label>
            <span class="badge" title="Default: René Magritte (Q7836)">default: Magritte</span>
          </div>

          <div class="muted">
            Selected: <span id="selId" class="mono">—</span>
            <span id="selLabel"></span>
            <span id="dsInfo" class="badge" style="display:none"></span>
          </div>

          <div class="list" id="results"></div>

          <div class="row">
            <div class="muted" style="flex:1">Dataset preview. Full dataset opens in a pop-up.</div>
            <button id="openDatasetBtn" class="secondary" disabled>Open full dataset</button>
          </div>
          <textarea id="dataPreview" class="preview" spellcheck="false" readonly></textarea>
        </div>
      </section>
    </div>

    <!-- RIGHT: closure + rules -->
    <div class="col">
      <section class="panel">
        <h2>Streaming deductive closure</h2>
        <div class="content">
          <div class="row">
            <span class="status" id="runStatus">Idle.</span>
            <span class="status">Derived: <span id="derivedCount">0</span></span>
            <span class="status">Fetched facts: <span id="fetchedCount">0</span></span>
          </div>
          <div class="out" id="outBox"></div>
        </div>
      </section>

      <section class="panel">
        <h2>N3 logic rules</h2>
        <div class="content">
          <div class="muted">
            This version avoids Wikidata TTL fetches (CORS issues) by using the Wikidata API + a small N3 conversion.
            It also demonstrates “dynamic fetch” by turning a derived request into new facts (wikiquote extract).
          </div>
          <textarea id="rulesBox" class="rules" spellcheck="false"></textarea>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal: full dataset -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Full dataset">
      <div class="modalHeader">
        <div class="title">Full dataset (Turtle/N3)</div>
        <button id="modalCloseBtn" class="secondary">Close</button>
      </div>
      <div class="modalBody">
        <div class="muted">This is the full Turtle/N3 that Eyeling reasons over.</div>
        <textarea id="dataFull" class="full" spellcheck="false" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- eyeling.js must provide: window.eyeling.reasonStream(...) and worker importScripts('eyeling.js') must parse it -->
  <script src="eyeling.js"></script>

  <script>
    const DEFAULT_RULES = `# Eyeling rules (CORS-safe “dynamic fetch” demo)
@prefix wd: <http://www.wikidata.org/entity/> .
@prefix wdt: <http://www.wikidata.org/prop/direct/> .
@prefix wikibase: <http://wikiba.se/ontology#> .
@prefix schema: <http://schema.org/> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix : <http://example.org/> .

# Basic typing lift
{ ?x wdt:P31 ?c } => { ?x a ?c } .
{ ?c wdt:P279 ?d } => { ?c rdfs:subClassOf ?d } .
{ ?a rdfs:subClassOf ?b . ?b rdfs:subClassOf ?c } => { ?a rdfs:subClassOf ?c } .
{ ?x a ?c . ?c rdfs:subClassOf ?d } => { ?x a ?d } .

# Find the Italian Wikiquote sitelink for an item and *request* a fetch.
# (This avoids log:content / web fetching inside N3.)
{ ?article a schema:Article ;
          schema:about ?item ;
          schema:isPartOf <https://it.wikiquote.org/> ;
          schema:name ?title .
} => { ?item :needsWikiquoteExtract ?title } .

# If we later inject :wikiquoteExtract facts, tag the item as having quotes.
{ ?item :wikiquoteExtract ?txt } => { ?item :hasWikiquote true } .
`;

    const TOY_DATA = `@prefix wd: <http://www.wikidata.org/entity/> .
@prefix wdt: <http://www.wikidata.org/prop/direct/> .
@prefix schema: <http://schema.org/> .
@prefix : <http://example.org/> .

wd:Q7836 wdt:P31 wd:Q5 .
<https://it.wikiquote.org/wiki/Ren%C3%A9_Magritte> a schema:Article ;
  schema:about wd:Q7836 ;
  schema:isPartOf <https://it.wikiquote.org/> ;
  schema:name "René Magritte" .
`;

    const MAGRITTE_LABEL = "René Magritte";
    const MAGRITTE_QID = "Q7836";
    const PREVIEW_LINES = 220;

    const $ = (id) => document.getElementById(id);

    async function showEyelingVersion(){
      const el = $('eyelingVersion');
      if (!el) return;

      // Prefer an exported version if available
      const v = (window.eyeling && (window.eyeling.version || window.eyeling.VERSION)) || null;
      if (v) { el.textContent = `Eyeling v${v}`; return; }

      // Fallback: read package.json from the same directory (works on GitHub Pages / http(s))
      try{
        const res = await fetch('./package.json', { cache: 'no-store' });
        if (res.ok){
          const j = await res.json();
          if (j && j.version){ el.textContent = `Eyeling v${j.version}`; return; }
        }
      } catch(_) {}

      el.textContent = 'Eyeling (version ?)';
    }

    $('rulesBox').value = DEFAULT_RULES;

    let selected = null;
    let worker = null;
    let runId = 0;
    let isRunning = false;
    let lastSelectedDiv = null;
    let resultDivById = new Map();

    let datasetN3 = '';
    let fetchedFacts = new Set();
    let shownDerived = new Set();

    function updateButtons(){
      const hasSelection = !!selected;
      const hasData = !!datasetN3.trim();
      $('loadBtn').disabled = isRunning || !hasSelection;
      $('reasonBtn').disabled = isRunning || !hasData;
      $('openDatasetBtn').disabled = !hasData;
    }

    function setStatus(text){ $('runStatus').textContent = text; }
    function clearOutput(){
      $('outBox').textContent = `# Derived triples (streaming):
`;
      $('derivedCount').textContent = '0';
      shownDerived.clear();
    }

    function addRunHeader(tag){
      const stamp = new Date().toLocaleString();
      const line = `
# ---- ${tag} @ ${stamp} ----
`;
      $('outBox').textContent += line;
    }

    function appendTriples(triples){
      const out = [];
      for (const t of triples){
        if (shownDerived.has(t)) continue;
        shownDerived.add(t);
        out.push(t);
      }
      if (!out.length) return;
      $('outBox').textContent += out.join('\n') + '\n';
      $('derivedCount').textContent = String(shownDerived.size);
    }

    function setDataset(text){
      datasetN3 = text || '';
      const lines = datasetN3.split(/\r?\n/);
      const shown = lines.slice(0, PREVIEW_LINES).join('\n');
      const suffix = lines.length > PREVIEW_LINES
        ? `\n\n# … (${lines.length - PREVIEW_LINES} more lines hidden; click "Open full dataset")`
        : '';
      $('dataPreview').value = shown + suffix;
      $('dataFull').value = datasetN3;

      const bytes = new Blob([datasetN3]).size;
      const kb = Math.round(bytes / 1024);
      const info = `${lines.length.toLocaleString()} lines · ~${kb.toLocaleString()} KB`;
      const badge = $('dsInfo');
      badge.style.display = datasetN3 ? 'inline-block' : 'none';
      badge.textContent = info;

      $('fetchedCount').textContent = String(fetchedFacts.size);
      updateButtons();
    }

    function addFactN3(tripleLine){
      const key = tripleLine.trim();
      if (!key) return false;
      if (fetchedFacts.has(key)) return false;
      fetchedFacts.add(key);
      datasetN3 += '\n' + key + '\n';
      setDataset(datasetN3);
      return true;
    }

    const WD_API = 'https://www.wikidata.org/w/api.php';

    async function wdSearch(query){
      const url = `${WD_API}?action=wbsearchentities&format=json&language=en&limit=10&origin=*&search=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Wikidata search failed: HTTP ${res.status}`);
      const json = await res.json();
      return (json.search || []).map(x => ({
        id: x.id,
        label: x.label || x.id,
        description: x.description || ''
      }));
    }

    async function wbGetEntities(ids){
      const url = `${WD_API}?action=wbgetentities&format=json&origin=*&ids=${encodeURIComponent(ids.join('|'))}&props=claims|sitelinks|labels`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`wbgetentities failed: HTTP ${res.status}`);
      return await res.json();
    }

    function escLiteral(s){
      const t = String(s).replace(/\\/g, '\\\\').replace(/"""/g, '\"""');
      return '"""' + t + '"""';
    }

    function qidToIri(id){
      if (/^Q\d+$/.test(id)) return `wd:${id}`;
      if (/^P\d+$/.test(id)) return `wd:${id}`;
      return null;
    }

    function siteToBaseUrl(site){
      const mWq = site.match(/^([a-z-]+)wikiquote$/);
      if (mWq) return `https://${mWq[1]}.wikiquote.org/wiki/`;
      const mWp = site.match(/^([a-z-]+)wiki$/);
      if (mWp) return `https://${mWp[1]}.wikipedia.org/wiki/`;
      if (site === 'commonswiki') return 'https://commons.wikimedia.org/wiki/';
      return null;
    }

    function n3PfxHeader(){
      return [
        '@prefix wd: <http://www.wikidata.org/entity/> .',
        '@prefix wdt: <http://www.wikidata.org/prop/direct/> .',
        '@prefix wikibase: <http://wikiba.se/ontology#> .',
        '@prefix schema: <http://schema.org/> .',
        '@prefix : <http://example.org/> .',
        ''
      ].join('\n');
    }

    function entityJsonToMinimalN3(entity, minimalOnly){
      const lines = [];
      const eid = entity.id;
      lines.push(`${qidToIri(eid)} a wikibase:${entity.type === 'property' ? 'Property' : 'Item'} .`);

      const claims = entity.claims || {};
      for (const pid of Object.keys(claims)){
        const stmts = claims[pid] || [];
        for (const st of stmts){
          const mainsnak = st.mainsnak;
          if (!mainsnak || mainsnak.snaktype !== 'value') continue;
          const dv = mainsnak.datavalue;
          if (!dv) continue;

          const subj = qidToIri(eid);
          const pred = `wdt:${pid}`;

          if (dv.type === 'wikibase-entityid'){
            const valId = dv.value && dv.value.id;
            const obj = qidToIri(valId);
            if (!obj) continue;
            lines.push(`${subj} ${pred} ${obj} .`);
          } else if (!minimalOnly && dv.type === 'string'){
            lines.push(`${subj} ${pred} ${escLiteral(dv.value)} .`);
          }
        }
      }

      const sitelinks = entity.sitelinks || {};
      for (const site of Object.keys(sitelinks)){
        const base = siteToBaseUrl(site);
        if (!base) continue;
        const title = sitelinks[site].title;
        if (!title) continue;

        const urlTitle = encodeURIComponent(title.replace(/ /g, '_'));
        const articleUrl = `<${base}${urlTitle}>`;

        const isPartOf =
          site.endsWith('wikiquote') ? `<https://${site.replace('wikiquote','')}.wikiquote.org/>` :
          site.endsWith('wiki') ? `<https://${site.replace('wiki','')}.wikipedia.org/>` :
          null;

        lines.push(`${articleUrl} a schema:Article ; schema:about ${qidToIri(eid)} ;` +
          (isPartOf ? ` schema:isPartOf ${isPartOf} ;` : '') +
          ` schema:name ${escLiteral(title)} .`);
      }

      return lines.join('\n');
    }

    async function fetchItWikiquoteExtract(title){
      const url = `https://it.wikiquote.org/w/api.php?action=query&prop=extracts&explaintext=1&exsectionformat=plain&format=json&origin=*&titles=${encodeURIComponent(title)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`wikiquote API failed: HTTP ${res.status}`);
      const j = await res.json();
      const pages = j && j.query && j.query.pages ? Object.values(j.query.pages) : [];
      const page = pages[0] || {};
      return page.extract || '';
    }

    function ensureWorker(){
      if (worker) worker.terminate();

      const workerSrc = `
        importScripts('eyeling.js');
        self.onmessage = (ev) => {
          const { runId, dataN3, rulesN3 } = ev.data;
          let buffer = [];
          const FLUSH_EVERY = 4;

          try {
            const program = rulesN3 + "\\n\\n" + dataN3;

            self.eyeling.reasonStream(program, {
              onDerived: ({ triple }) => {
                buffer.push(triple);
                if (buffer.length >= FLUSH_EVERY) {
                  self.postMessage({ runId, type: 'derived_batch', triples: buffer });
                  buffer = [];
                }
              }
            });

            if (buffer.length) self.postMessage({ runId, type: 'derived_batch', triples: buffer });
            self.postMessage({ runId, type: 'done' });
          } catch (e) {
            self.postMessage({ runId, type: 'error', message: (e && e.message) ? e.message : String(e) });
          }
        };
      `;

      const blob = new Blob([workerSrc], { type: 'text/javascript' });
      worker = new Worker(URL.createObjectURL(blob));
      return worker;
    }

    function runReasoningMainThread(program){
      if (!window.eyeling || !window.eyeling.reasonStream) {
        throw new Error("Eyeling not loaded. Ensure eyeling.js exposes window.eyeling.reasonStream.");
      }

      const triples = [];
      window.eyeling.reasonStream(program, {
        onDerived: ({ triple }) => triples.push(triple)
      });
      appendTriples(triples);
    }

    let rerunTimer = null;
    function scheduleRerun(){
      if (rerunTimer) return;
      rerunTimer = setTimeout(() => {
        rerunTimer = null;
        addRunHeader('Auto re-run (after fetch)');
        runReasoning();
      }, 250);
    }

    async function maybeHandleDynamicFetch(triples){
      if (!$('autoFetchWikiquote').checked) return;

      for (const t of triples){
        if (!t.includes('needsWikiquoteExtract')) continue;

        const m = t.match(/^(\S+)\s+(\S+)\s+(.+)\s*\.\s*$/);
        if (!m) continue;
        const subj = m[1], pred = m[2], obj = m[3];

        if (!pred.includes('needsWikiquoteExtract')) continue;
        if (!/^wd:Q\d+$/.test(subj)) continue;

        let title = null;
        const mLong = obj.match(/^"""\s*([\s\S]*?)\s*"""\s*$/);
        if (mLong) title = mLong[1];
        else {
          const mShort = obj.match(/^"([^"]*)"/);
          if (mShort) title = mShort[1];
        }
        if (!title) continue;

        try{
          setStatus(`Fetching it.wikiquote extract for ${subj}…`);
          const extract = await fetchItWikiquoteExtract(title);
          if (!extract) {
            setStatus(`No extract found on it.wikiquote for "${title}".`);
            continue;
          }
          const capped = extract.length > 2000 ? (extract.slice(0, 2000) + '…') : extract;
          const fact = `${subj} <http://example.org/wikiquoteExtract> ${escLiteral(capped)} .`;
          const added = addFactN3(fact);
          if (added) {
            $('fetchedCount').textContent = String(fetchedFacts.size);
            setStatus('Fetched wikiquote extract and added as fact; re-running reasoning…');
            scheduleRerun();
          }
        } catch(e){
          setStatus(`Wikiquote fetch failed: ${e.message || e}`);
        }
      }
    }

    function runReasoning(){
      const rules = $('rulesBox').value;
      if (!datasetN3.trim() || !rules.trim()) return;

      const program = rules + "\n\n" + datasetN3;

      isRunning = true;
      updateButtons();
      setStatus('Reasoning (streaming)…');

      const supportsWorker = (typeof Worker !== 'undefined');

      if (supportsWorker) {
        const w = ensureWorker();
        const thisRun = ++runId;

        w.onmessage = async (ev) => {
          const msg = ev.data;
          if (msg.runId !== thisRun) return;

          if (msg.type === 'derived_batch') {
            appendTriples(msg.triples);
            await maybeHandleDynamicFetch(msg.triples);
          } else if (msg.type === 'done') {
            setStatus(`Done. (Run ${thisRun})`);
            isRunning = false;
            updateButtons();
          } else if (msg.type === 'error') {
            setStatus(`Reasoning error: ${msg.message}`);
            isRunning = false;
            updateButtons();
          }
        };

        w.onerror = () => {
          try {
            setStatus("Worker error; falling back to main-thread run…");
            runReasoningMainThread(program);
            setStatus("Done (fallback).");
          } catch (err) {
            setStatus(`Reasoning error: ${err.message || err}`);
          } finally {
            isRunning = false;
            updateButtons();
          }
        };

        w.postMessage({ runId: thisRun, dataN3: datasetN3, rulesN3: rules });
        return;
      }

      try {
        runReasoningMainThread(program);
        setStatus("Done (no worker).");
      } catch (e) {
        setStatus(`Reasoning error: ${e.message || e}`);
      } finally {
        isRunning = false;
        updateButtons();
      }
    }

    function selectResult(r, div){
      selected = r;
      $('selId').textContent = r.id;
      $('selLabel').textContent = ` — ${r.label}`;

      if (lastSelectedDiv) lastSelectedDiv.classList.remove('selected');
      if (div) { div.classList.add('selected'); lastSelectedDiv = div; }
      else { lastSelectedDiv = null; }

      updateButtons();
    }

    async function doSearch(){
      const q = $('searchBox').value.trim();
      if (!q) return [];

      $('results').innerHTML = '';
      resultDivById = new Map();
      selected = null;
      $('selId').textContent = '—';
      $('selLabel').textContent = '';
      lastSelectedDiv = null;
      setStatus('Searching…');
      updateButtons();

      try{
        const results = await wdSearch(q);
        setStatus(`Found ${results.length} result(s). Click one, then “Load selection”.`);

        for (const r of results){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `<div class="mono">${r.id}</div><div style="font-weight:800">${r.label}</div><div class="muted">${r.description}</div>`;
          div.onclick = () => selectResult(r, div);
          $('results').appendChild(div);
          resultDivById.set(r.id, div);
        }

        updateButtons();
        return results;
      } catch(e){
        setStatus(`Search error: ${e.message || e}`);
        updateButtons();
        return [];
      }
    }

    async function loadSelection(){
      if (!selected) return;

      isRunning = true;
      updateButtons();
      setStatus(`Loading ${selected.id} (via Wikidata API)…`);

      try{
        fetchedFacts = new Set();
        $('fetchedCount').textContent = '0';

        const json = await wbGetEntities([selected.id]);
        const ent = json && json.entities && json.entities[selected.id];
        if (!ent) throw new Error(`No entity data returned for ${selected.id}`);

        const minimalOnly = $('minimalOnly').checked;
        const n3 = n3PfxHeader() + entityJsonToMinimalN3(ent, minimalOnly);

        setDataset(n3);
        setStatus(`Loaded ${selected.id}. Ready to reason.`);
      } catch(e){
        setStatus(`Load error: ${e.message || e}`);
      } finally {
        isRunning = false;
        updateButtons();
      }
    }

    function loadToy(){
      selected = null;
      if (lastSelectedDiv) { lastSelectedDiv.classList.remove('selected'); lastSelectedDiv = null; }
      $('selId').textContent = 'toy';
      $('selLabel').textContent = ' — local demo data';
      fetchedFacts = new Set();
      $('fetchedCount').textContent = '0';
      setDataset(TOY_DATA);
      setStatus('Toy example loaded. Ready to reason.');
      updateButtons();
    }

    function openModal(){
      $('modalBackdrop').style.display = 'flex';
      $('modalBackdrop').setAttribute('aria-hidden', 'false');
    }
    function closeModal(){
      $('modalBackdrop').style.display = 'none';
      $('modalBackdrop').setAttribute('aria-hidden', 'true');
    }
    $('openDatasetBtn').onclick = openModal;
    $('modalCloseBtn').onclick = closeModal;
    $('modalBackdrop').addEventListener('click', (e) => { if (e.target === $('modalBackdrop')) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    $('searchBtn').onclick = doSearch;
    $('loadBtn').onclick = loadSelection;
    $('toyBtn').onclick = () => { loadToy(); setTimeout(() => { if ($('clearOnRun').checked) clearOutput(); addRunHeader('Toy run'); runReasoning(); }, 60); };
    $('clearBtn').onclick = () => { clearOutput(); setStatus('Cleared.'); };
    $('reasonBtn').onclick = () => { if ($('clearOnRun').checked) clearOutput(); addRunHeader('Manual run'); runReasoning(); };

    $('searchBox').addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

    async function loadDefaultMagritte(){
      $('searchBox').value = MAGRITTE_LABEL;
      const results = await doSearch();
      const target = results.find(r => r.id === MAGRITTE_QID) || results[0];
      if (!target) return;
      const div = resultDivById.get(target.id);
      selectResult(target, div);
      await loadSelection();
      setTimeout(() => { if ($('clearOnRun').checked) clearOutput(); addRunHeader('Auto run (default)'); runReasoning(); }, 80);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await showEyelingVersion();
        await loadDefaultMagritte();
      } catch (e) {
        setStatus(`Default load failed (${e.message || e}). Loading toy example instead…`);
        loadToy();
        setTimeout(() => { if ($('clearOnRun').checked) clearOutput(); addRunHeader('Auto run (toy fallback)'); runReasoning(); }, 60);
      }
    });
  </script>
</body>
</html>
