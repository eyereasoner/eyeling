<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eyeling × Wikidata — Streaming Closure (Practical Layout)</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --text:#1b2430;
      --muted:#5b6b7c;
      --line:#d6dee8;
      --btn:#2563eb;
      --btn2:#e7edf7;
      --codebg:#f3f5f9;
    }

    html, body{
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }

    .topbar{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topbar input{
      background: #fff;
      border: 1px solid var(--line);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 10px;
      flex: 1;
    }

    .topbar button{
      background: var(--btn);
      border: 0;
      color: white;
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      white-space: nowrap;
    }
    .topbar button.secondary{
      background: var(--btn2);
      color: var(--text);
      border: 1px solid var(--line);
      font-weight: 700;
    }
    .topbar button:disabled{
      opacity: 0.55;
      cursor: not-allowed;
    }

    /* Two columns: LEFT = browser + dataset, RIGHT = closure + rules */
    .layout{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
      box-sizing:border-box;
      max-width: 1500px;
      margin: 0 auto;
      align-items: start;
    }

    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
    }

    .col{
      display:flex;
      flex-direction: column;
      gap: 12px;
      min-width: 0;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 14px;
      display:flex;
      flex-direction: column;
      overflow:hidden;
      box-shadow: 0 4px 16px rgba(16,24,40,.06);
    }

    .panel h2{
      margin:0;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 900;
      border-bottom: 1px solid var(--line);
      color: var(--muted);
      letter-spacing: .2px;
    }

    .panel .content{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap:10px;
    }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row label { font-size: 12px; color: var(--muted); display:flex; gap:6px; align-items:center; }
    .muted { color: var(--muted); font-size: 12px; }
    .status { font-size: 12px; color: var(--muted); }

    textarea{
      width: 100%;
      background: var(--codebg);
      border: 1px solid var(--line);
      color: var(--text);
      padding: 10px;
      border-radius: 12px;
      box-sizing:border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.35;
    }

    textarea.preview{
      height: 220px;
      overflow: auto;
      resize: vertical;
    }

    textarea.rules{
      height: min(42vh, 420px);
      min-height: 240px;
      overflow: auto;
      resize: vertical;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 240px;
      overflow: auto;
      padding-right: 2px;
    }

    .item{
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      cursor:pointer;
      user-select: none;
    }
    .item:hover{
      border-color: #9db6ee;
      box-shadow: 0 2px 10px rgba(37,99,235,.10);
    }
    .item.selected{
      border-color: #2563eb;
      box-shadow: 0 2px 12px rgba(37,99,235,.16);
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .out{
      white-space: pre-wrap;
      word-break: break-word;
      background: var(--codebg);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      line-height: 1.35;
      max-height: min(52vh, 560px);
      overflow: auto;
    }

    .badge{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      background: #fff;
      color: var(--muted);
    }

    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(12,18,28,.55);
      display:none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 1000;
    }
    .modal{
      width: min(1100px, 96vw);
      height: min(86vh, 900px);
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--line);
      box-shadow: 0 20px 80px rgba(0,0,0,.25);
      display:flex;
      flex-direction: column;
      overflow:hidden;
    }
    .modalHeader{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:10px;
      background: #fff;
    }
    .modalHeader .title{
      font-weight: 900;
      color: var(--muted);
      font-size: 14px;
    }
    .modalBody{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap:10px;
      height: 100%;
    }
    textarea.full{
      flex: 1 1 auto;
      height: 100%;
      resize: none;
      overflow: auto;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <input id="searchBox" placeholder="Search Wikidata (e.g., René Magritte, Q7836, P26)..." />
    <button id="searchBtn">Search</button>
    <button id="loadBtn" class="secondary" disabled>Load selection</button>
    <button id="toyBtn" class="secondary">Load toy example</button>
    <button id="reasonBtn" disabled>Reason (stream)</button>
  </div>

  <div class="layout">
    <!-- LEFT: browser + dataset -->
    <div class="col">
      <section class="panel" id="panelBrowse">
        <h2>Wikidata browser + dataset</h2>
        <div class="content">
          <div class="row">
            <label><input type="checkbox" id="expandClasses" /> fetch P31/P279 class hierarchy (depth 2)</label>
            <label><input type="checkbox" id="fetchRuleProps" checked /> fetch property pages referenced by rules</label>
            <span class="badge" title="Default: René Magritte (Q7836)">default: Magritte</span>
          </div>

          <div class="muted">
            Selected: <span id="selId" class="mono">—</span>
            <span id="selLabel"></span>
            <span id="dsInfo" class="badge" style="display:none"></span>
          </div>

          <div class="list" id="results"></div>

          <div class="row">
            <div class="muted" style="flex:1">Dataset preview (first lines). Full dataset opens in a pop-up.</div>
            <button id="openDatasetBtn" class="secondary" disabled>Open full dataset</button>
          </div>

          <textarea id="dataPreview" class="preview" spellcheck="false" readonly></textarea>
        </div>
      </section>
    </div>

    <!-- RIGHT: closure + rules -->
    <div class="col">
      <section class="panel" id="panelOut">
        <h2>Streaming deductive closure</h2>
        <div class="content">
          <div class="row">
            <span class="status" id="runStatus">Idle.</span>
            <span class="status">Derived: <span id="derivedCount">0</span></span>
          </div>
          <div class="out" id="outBox"></div>
        </div>
      </section>

      <section class="panel" id="panelRules">
        <h2>N3 logic rules</h2>
        <div class="content">
          <div class="muted">Edit rules here. (Reasoning runs over rules + the full dataset in memory.)</div>
          <textarea id="rulesBox" class="rules" spellcheck="false"></textarea>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal: full dataset -->
  <div class="modalBackdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Full dataset">
      <div class="modalHeader">
        <div class="title">Full dataset (Turtle/N3)</div>
        <button id="modalCloseBtn" class="secondary">Close</button>
      </div>
      <div class="modalBody">
        <div class="muted">This is the full Turtle/N3 that Eyeling reasons over.</div>
        <textarea id="dataFull" class="full" spellcheck="false" readonly></textarea>
      </div>
    </div>
  </div>

  <script src="eyeling.js"></script>

  <script>
    const DEFAULT_RULES = `# Eyeling N3 rules (Wikidata-flavoured)
@prefix wd: <http://www.wikidata.org/entity/> .
@prefix wdt: <http://www.wikidata.org/prop/direct/> .
@prefix wikibase: <http://wikiba.se/ontology#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

{ ?x wdt:P31 ?c } => { ?x a ?c } .
{ ?c wdt:P279 ?d } => { ?c rdfs:subClassOf ?d } .

{ ?a rdfs:subClassOf ?b . ?b rdfs:subClassOf ?c } => { ?a rdfs:subClassOf ?c } .
{ ?x a ?c . ?c rdfs:subClassOf ?d } => { ?x a ?d } .

{ ?prop wdt:P31 wd:Q18647518 .
  ?prop wikibase:directClaim ?p .
  ?s ?p ?o
} => { ?o ?p ?s } .

{ ?prop wdt:P1696 ?inv .
  ?prop wikibase:directClaim ?p .
  ?inv wikibase:directClaim ?q .
  ?s ?p ?o
} => { ?o ?q ?s } .
`;

    const TOY_DATA = `# Toy example (small and readable)
@prefix wd: <http://www.wikidata.org/entity/> .
@prefix wdt: <http://www.wikidata.org/prop/direct/> .
@prefix wikibase: <http://wikiba.se/ontology#> .

wd:QAlice wdt:P31 wd:Q5 .
wd:Q5 wdt:P279 wd:Q215627 .

wd:P26 wdt:P31 wd:Q18647518 .
wd:P26 wikibase:directClaim wdt:P26 .
wd:QAlice wdt:P26 wd:QBob .

wd:P361 wdt:P1696 wd:P527 .
wd:P361 wikibase:directClaim wdt:P361 .
wd:P527 wikibase:directClaim wdt:P527 .
wd:QWheel wdt:P361 wd:QCar .
`;

    const MAGRITTE_LABEL = "René Magritte";
    const MAGRITTE_QID = "Q7836";
    const PREVIEW_LINES = 220;

    const $ = (id) => document.getElementById(id);
    $('rulesBox').value = DEFAULT_RULES;

    let selected = null;
    let worker = null;
    let runId = 0;
    let isRunning = false;
    let lastSelectedDiv = null;
    let resultDivById = new Map();
    let datasetN3 = '';

    function updateButtons(){
      const hasSelection = !!selected;
      const hasData = !!datasetN3.trim();
      $('loadBtn').disabled = isRunning || !hasSelection;
      $('reasonBtn').disabled = isRunning || !hasData;
      $('openDatasetBtn').disabled = !hasData;
    }

    function setStatus(text){ $('runStatus').textContent = text; }
    function clearOutput(){
      $('outBox').textContent = '# Derived triples (streaming):\n';
      $('derivedCount').textContent = '0';
    }
    function appendTriples(triples){
      $('outBox').textContent += triples.join('\n') + '\n';
    }

    function setDataset(text){
      datasetN3 = text || '';
      const lines = datasetN3.split(/\r?\n/);
      const shown = lines.slice(0, PREVIEW_LINES).join('\n');
      const suffix = lines.length > PREVIEW_LINES
        ? `\n\n# … (${lines.length - PREVIEW_LINES} more lines hidden; click "Open full dataset")`
        : '';
      $('dataPreview').value = shown + suffix;
      $('dataFull').value = datasetN3;

      const bytes = new Blob([datasetN3]).size;
      const kb = Math.round(bytes / 1024);
      const info = `${lines.length.toLocaleString()} lines · ~${kb.toLocaleString()} KB`;
      const badge = $('dsInfo');
      badge.style.display = datasetN3 ? 'inline-block' : 'none';
      badge.textContent = info;

      updateButtons();
    }

    const WD_API = 'https://www.wikidata.org/w/api.php';

    async function wdSearch(query){
      const url = `${WD_API}?action=wbsearchentities&format=json&language=en&limit=10&origin=*&search=${encodeURIComponent(query)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Wikidata search failed: HTTP ${res.status}`);
      const json = await res.json();
      return (json.search || []).map(x => ({
        id: x.id,
        label: x.label || x.id,
        description: x.description || ''
      }));
    }

    async function fetchEntityTTL(id){
      const url = `https://www.wikidata.org/wiki/Special:EntityData/${encodeURIComponent(id)}.ttl`;
      const res = await fetch(url, { headers: { 'Accept': 'text/turtle,*/*;q=0.1' } });
      if (!res.ok) throw new Error(`EntityData fetch failed for ${id}: HTTP ${res.status}`);
      return await res.text();
    }

    function uniq(arr){ return [...new Set(arr)]; }

    function extractQidsFromTTL(ttl, propPfx){
      const re = new RegExp(propPfx.replace(':','\\:') + '\\s+wd\\:Q(\\d+)', 'g');
      const out = [];
      let m;
      while ((m = re.exec(ttl)) !== null) out.push('Q' + m[1]);
      return uniq(out);
    }

    function extractPidsFromRules(rules){
      const re = /\bP\d+\b/g;
      const out = [];
      let m;
      while ((m = re.exec(rules)) !== null) out.push(m[0]);
      return uniq(out);
    }

    async function expandClassesDepth2(baseTTL){
      const depth1 = uniq([
        ...extractQidsFromTTL(baseTTL, 'wdt:P31'),
        ...extractQidsFromTTL(baseTTL, 'wdt:P279'),
      ]).slice(0, 40);

      const ttlMap = new Map();
      for (const q of depth1){
        try { ttlMap.set(q, await fetchEntityTTL(q)); } catch (_) {}
      }

      const depth2Candidates = [];
      for (const ttl of ttlMap.values()){
        depth2Candidates.push(...extractQidsFromTTL(ttl, 'wdt:P279'));
      }

      const depth2 = uniq(depth2Candidates).slice(0, 60);
      for (const q of depth2){
        if (ttlMap.has(q)) continue;
        try { ttlMap.set(q, await fetchEntityTTL(q)); } catch (_) {}
      }

      return [...ttlMap.values()].join('\n\n');
    }

    async function fetchRulePropertyPages(rulesText){
      const pids = extractPidsFromRules(rulesText);
      const ttlChunks = [];
      for (const pid of pids){
        try { ttlChunks.push(await fetchEntityTTL(pid)); } catch (_) {}
      }
      return ttlChunks.join('\n\n');
    }

    function ensureWorker(){
      if (worker) worker.terminate();

      const workerSrc = `
        importScripts('eyeling.js');
        self.onmessage = (ev) => {
          const { runId, dataN3, rulesN3 } = ev.data;
          let derivedCount = 0;
          let buffer = [];
          const FLUSH_EVERY = 12;

          try {
            const program = rulesN3 + "\\n\\n" + dataN3;

            self.eyeling.reasonStream(program, {
              onDerived: ({ triple }) => {
                derivedCount++;
                buffer.push(triple);
                if (buffer.length >= FLUSH_EVERY) {
                  self.postMessage({ runId, type: 'derived_batch', triples: buffer });
                  buffer = [];
                }
              }
            });

            if (buffer.length) self.postMessage({ runId, type: 'derived_batch', triples: buffer });
            self.postMessage({ runId, type: 'done', derivedCount });
          } catch (e) {
            self.postMessage({ runId, type: 'error', message: (e && e.message) ? e.message : String(e) });
          }
        };
      `;

      const blob = new Blob([workerSrc], { type: 'text/javascript' });
      worker = new Worker(URL.createObjectURL(blob));
      return worker;
    }

    function runReasoningMainThread(program){
      if (!window.eyeling || !window.eyeling.reasonStream) {
        throw new Error("Eyeling not loaded. Ensure eyeling.js is next to this HTML and exposes self.eyeling.reasonStream.");
      }

      let derivedCount = 0;
      const triples = [];
      window.eyeling.reasonStream(program, {
        onDerived: ({ triple }) => {
          derivedCount++;
          triples.push(triple);
        }
      });

      appendTriples(triples);
      $('derivedCount').textContent = String(derivedCount);
    }

    function selectResult(r, div){
      selected = r;
      $('selId').textContent = r.id;
      $('selLabel').textContent = ` — ${r.label}`;

      if (lastSelectedDiv) lastSelectedDiv.classList.remove('selected');
      if (div) { div.classList.add('selected'); lastSelectedDiv = div; }
      else { lastSelectedDiv = null; }

      updateButtons();
    }

    async function doSearch(){
      const q = $('searchBox').value.trim();
      if (!q) return [];

      $('results').innerHTML = '';
      resultDivById = new Map();
      selected = null;
      $('selId').textContent = '—';
      $('selLabel').textContent = '';
      lastSelectedDiv = null;
      setStatus('Searching…');
      updateButtons();

      try{
        const results = await wdSearch(q);
        setStatus(`Found ${results.length} result(s). Click one, then “Load selection”.`);

        for (const r of results){
          const div = document.createElement('div');
          div.className = 'item';
          div.innerHTML = `<div class="mono">${r.id}</div><div style="font-weight:800">${r.label}</div><div class="muted">${r.description}</div>`;
          div.onclick = () => selectResult(r, div);
          $('results').appendChild(div);
          resultDivById.set(r.id, div);
        }

        updateButtons();
        return results;
      } catch(e){
        setStatus(`Search error: ${e.message || e}`);
        updateButtons();
        return [];
      }
    }

    async function loadSelection(){
      if (!selected) return;

      isRunning = true;
      updateButtons();
      setStatus(`Loading ${selected.id} RDF…`);

      try{
        const baseTTL = await fetchEntityTTL(selected.id);

        let extra = '';
        if ($('expandClasses').checked) {
          setStatus(`Fetching class hierarchy (depth 2)…`);
          extra += '\n\n' + await expandClassesDepth2(baseTTL);
        }
        if ($('fetchRuleProps').checked) {
          setStatus(`Fetching property pages referenced by rules…`);
          extra += '\n\n' + await fetchRulePropertyPages($('rulesBox').value);
        }

        setDataset(baseTTL + extra);
        setStatus(`Loaded ${selected.id}. Ready to reason.`);
      } catch(e){
        setStatus(`Load error: ${e.message || e}`);
      } finally {
        isRunning = false;
        updateButtons();
      }
    }

    function loadToy(){
      selected = null;
      if (lastSelectedDiv) { lastSelectedDiv.classList.remove('selected'); lastSelectedDiv = null; }
      $('selId').textContent = 'toy';
      $('selLabel').textContent = ' — local demo data';
      setDataset(TOY_DATA);
      setStatus('Toy example loaded. Ready to reason.');
      updateButtons();
    }

    function runReasoning(){
      const rules = $('rulesBox').value;
      if (!datasetN3.trim() || !rules.trim()) return;

      const program = rules + "\n\n" + datasetN3;

      clearOutput();
      isRunning = true;
      updateButtons();
      setStatus('Reasoning (streaming)…');

      const supportsWorker = (typeof Worker !== 'undefined');

      if (supportsWorker) {
        const w = ensureWorker();
        const thisRun = ++runId;
        let gotAnyMessage = false;

        const watchdog = setTimeout(() => {
          if (!gotAnyMessage) {
            try {
              setStatus("Worker didn't start (often on file://). Falling back to main-thread run…");
              runReasoningMainThread(program);
              setStatus("Done (fallback). For true live streaming, serve via http(s) (e.g., GitHub Pages).");
            } catch (e) {
              setStatus(`Reasoning error: ${e.message || e}`);
            } finally {
              isRunning = false;
              updateButtons();
            }
            try { w.terminate(); } catch(_) {}
          }
        }, 900);

        w.onmessage = (ev) => {
          const msg = ev.data;
          if (msg.runId !== thisRun) return;
          gotAnyMessage = true;

          if (msg.type === 'derived_batch') {
            appendTriples(msg.triples);
            $('derivedCount').textContent = String(
              Number($('derivedCount').textContent || '0') + msg.triples.length
            );
          } else if (msg.type === 'done') {
            clearTimeout(watchdog);
            setStatus(`Done. Derived ${msg.derivedCount} triple(s).`);
            isRunning = false;
            updateButtons();
          } else if (msg.type === 'error') {
            clearTimeout(watchdog);
            setStatus(`Reasoning error: ${msg.message}`);
            isRunning = false;
            updateButtons();
          }
        };

        w.onerror = () => {
          clearTimeout(watchdog);
          try {
            setStatus("Worker error; falling back to main-thread run…");
            runReasoningMainThread(program);
            setStatus("Done (fallback). For true live streaming, serve via http(s) (e.g., GitHub Pages).");
          } catch (err) {
            setStatus(`Reasoning error: ${err.message || err}`);
          } finally {
            isRunning = false;
            updateButtons();
          }
        };

        w.postMessage({ runId: thisRun, dataN3: datasetN3, rulesN3: rules });
        return;
      }

      try {
        runReasoningMainThread(program);
        setStatus("Done (no worker).");
      } catch (e) {
        setStatus(`Reasoning error: ${e.message || e}`);
      } finally {
        isRunning = false;
        updateButtons();
      }
    }

    // Modal
    function openModal(){
      $('modalBackdrop').style.display = 'flex';
      $('modalBackdrop').setAttribute('aria-hidden', 'false');
    }
    function closeModal(){
      $('modalBackdrop').style.display = 'none';
      $('modalBackdrop').setAttribute('aria-hidden', 'true');
    }
    $('openDatasetBtn').onclick = openModal;
    $('modalCloseBtn').onclick = closeModal;
    $('modalBackdrop').addEventListener('click', (e) => { if (e.target === $('modalBackdrop')) closeModal(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    // Wire up buttons
    $('searchBtn').onclick = doSearch;
    $('loadBtn').onclick = loadSelection;
    $('toyBtn').onclick = () => { loadToy(); setTimeout(runReasoning, 60); };
    $('reasonBtn').onclick = runReasoning;
    $('searchBox').addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });

    async function loadDefaultMagritte(){
      $('searchBox').value = MAGRITTE_LABEL;
      const results = await doSearch();
      const target = results.find(r => r.id === MAGRITTE_QID) || results[0];
      if (!target) return;
      const div = resultDivById.get(target.id);
      selectResult(target, div);
      await loadSelection();
      setTimeout(runReasoning, 60);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadDefaultMagritte();
      } catch (e) {
        setStatus(`Default load failed (${e.message || e}). Loading toy example instead…`);
        loadToy();
        setTimeout(runReasoning, 60);
      }
    });
  </script>
</body>
</html>
