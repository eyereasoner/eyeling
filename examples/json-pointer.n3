@prefix string: <http://www.w3.org/2000/10/swap/string#> .
@prefix list:   <http://www.w3.org/2000/10/swap/list#> .
@prefix log:    <http://www.w3.org/2000/10/swap/log#> .
@prefix ex:     <http://example.org/> .

ex:doc ex:json """{
  "users": [
    { "id": "u1", "email": "ada@example.org",     "profile/name": "Ada Lovelace" },
    { "id": "u2", "email": "bob@evil.invalid",    "profile/name": "Bob Mallory" }
  ],
  "policy": { "allowedDomains": ["example.org", "example.com"] }
}""" .

# Sanity check: key contains "/" so JSON Pointer must use "~1"
{
  ex:doc ex:json ?J .
  (?J "/users/0/profile~1name") string:jsonPointer "Ada Lovelace" .
} => {
  ex:checks ex:firstUserNameOk true .
} .

# Allowed users: email domain is in policy.allowedDomains
{
  ex:doc ex:json ?J .
  (?J "/policy/allowedDomains") string:jsonPointer ?Allowed .
  (?J "/users")                string:jsonPointer ?Users .

  ?Users list:iterate (?Idx ?UserJson) .
  (?UserJson "/id")            string:jsonPointer ?Id .
  (?UserJson "/email")         string:jsonPointer ?Email .
  (?UserJson "/profile~1name") string:jsonPointer ?Name .

  (?Email "@([^@]+)$") string:scrape ?EmailDomain .
  ?Allowed list:member ?EmailDomain .

  ("urn:example:user:%s" ?Id) string:format ?UriStr .
  ?User log:uri ?UriStr .
} => {
  ?User a ex:AllowedUser ;
        ex:name ?Name ;
        ex:email ?Email ;
        ex:emailDomain ?EmailDomain ;
        ex:userIndex ?Idx .
} .

# Blocked users: email domain is NOT in the allowlist
{
  ex:doc ex:json ?J .
  (?J "/policy/allowedDomains") string:jsonPointer ?Allowed .
  (?J "/users")                string:jsonPointer ?Users .

  ?Users list:iterate (?Idx ?UserJson) .
  (?UserJson "/id")            string:jsonPointer ?Id .
  (?UserJson "/email")         string:jsonPointer ?Email .
  (?UserJson "/profile~1name") string:jsonPointer ?Name .

  (?Email "@([^@]+)$") string:scrape ?EmailDomain .
  ?Allowed list:notMember ?EmailDomain .

  ("urn:example:user:%s" ?Id) string:format ?UriStr .
  ?User log:uri ?UriStr .
} => {
  ?User a ex:BlockedUser ;
        ex:name ?Name ;
        ex:email ?Email ;
        ex:emailDomain ?EmailDomain ;
        ex:userIndex ?Idx .
} .

